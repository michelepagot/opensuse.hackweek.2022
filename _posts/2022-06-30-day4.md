---
layout: post
title:  "Day4 is windy"
date: 2022-06-30 09:00:00 -0000
author: michelepagot
---

<a onclick="window.history.back()">Back</a>

Today I'd like to discuss about an home and lua-ling around. It turn out that I mostly perl-ing around (in a circle).

# DONE

## Hackweek webpage

## openQA

### Needles and tags

I have these 3 needles and I'm trying to figure out a good strategy to tag them.
```
% ls wez*.json |xargs -I{} sh -c $'echo "-----------------"; echo "{}"; cat {}|jq \'.tags\''
-----------------
wezterm-tab-top-20220628.json
[
  "wezterm"
]
-----------------
wezterm-tab-top-20220629.json
[
  "two-tabs",
  "wezterm"
]
-----------------
wezterm-test_terminal-1-20220629.json
[
  "test-wezterm-1",
  "test_terminal",
  "wezterm"
]
```

In case of two tab opened, I wrongly pretend to match for them like:
```
assert_screen([qw(wezterm two-tabs)], 10);
```

It result in openQA to try to match with all the 3 needles.

The right syntax to only have **wezterm-tab-top-20220629**  used for the matching is:
```
assert_screen('two-tabs', 10);
```

First Wezterm set of needles [committed](https://github.com/mpagot/os-autoinst-needles-opensuse/commit/a66c17fec5f02a2ee75fe684000c7ca393a1daec).

### Test assets
My idea is to test different Wezterm features by letting the test to load, for each test, a different `wezterm.lua` file.
One possibility to implement it in openQA is to consider each `wezterm.lua` as a test asset.

#### Static files
Test assets could be static files, stored in a dedicated folder near to the test code. Te folder is **data**.
[Here](https://github.com/mpagot/os-autoinst-distri-opensuse/commit/4ced5a77b9cac1323b451fa0164191bf5eb359a6) an example of an asset.
```
local wezterm = require 'wezterm';

return {
  keys = {
    {key="n", mods="SUPER",          action=wezterm.action{SpawnTab="CurrentPaneDomain"}},
  },
}
```

openQA also provide some perl functions that help to _inject_ the file in the SUT machine:
* [data_url](http://open.qa/api/testapi/#_data_url)
* [autoinst_url](http://open.qa/api/testapi/#_autoinst_url)

Technically it the SUT that retrieve the assets that it needs. These two API are mostly to let the SUT to know the URL where to get the assets from.


#### Configurable assets
openQA also allow the test to generate the assets on the fly or to generate them from a template (e.g [data/add_on_products.xml](https://github.com/os-autoinst/os-autoinst-distri-opensuse/blob/master/data/add_on_products.xml)). The template is:
1. read using [get_test_data](http://open.qa/api/testapi/#_get_test_data),
2. edited,
```
$config =~ s/\{\{NEW_TAB_KEY\}\}/$key/g;
```

3. written to file in a dedicated area with [save_tmp_file](http://open.qa/api/testapi/#_save_tmp_file),
4. the link is provided to the SUT to be downloaded 

(e.g. [generate_dud.pm](https://github.com/os-autoinst/os-autoinst-distri-opensuse/blob/master/tests/console/generate_dud.pm))

So I can think about creating a template for the _SpawnTab_ key binding.

```
local wezterm = require 'wezterm';

return {
  keys = {
    {key="{{NEW_TAB_KEY}}", mods="SUPER",          action=wezterm.action{SpawnTab="CurrentPaneDomain"}},
  },
}
```

### Run qcow2 locally

The Wezterm test is currently executed in a openSUSE Tumbleweed machine. In particular it is executed on a machine booted from a pre-configured HDD image in qcow2 format cloned from https://openqa.opensuse.org/tests/2436441. For some issue it could be tedious to:
* change some perl code
* trigger a openQA job
* look at what happens using the recorded video (or archived logs with [upload_logs](http://open.qa/api/testapi/#_upload_logs))

But openQA is so kind to provide, on its web interface, a link to download the used qcow2 file, so it can be downloaded locally.

There are different approaches to run it locally:
* **openqa2vm** [https://github.com/czerw/openqa2vm](https://github.com/czerw/openqa2vm)
* **qemu** The idea is to directly pass the image to qemu, exactly as it is done within openQA. The full command can be retrieved from one of the test execution log files: **autoinst-log.txt**. Here an [article](https://openqa-bites.github.io/posts/2022-04-13-qemu-aarch64/) about it.

#### libvirt
virt-manager


## Wezterm

## Perl
Some of the Perl topics that I read about today.

* **Sub arguments with default value**: [perlsub](https://perldoc.perl.org/perlsub)

```
sub activate_config() {
    my ($self) = shift;
    my ($config) = shift;
    my %args = @_;
    my $cfg_dir = $args{cfg_dir} || '$HOME';
    my $cfg_filename = $args{cfg_filename} || '.wezterm.lua';

```

* **regexp** I need to validate the strings provided as argument to one of the Wezterm openQA test library: **activate_config**. Some of the strings can contain some reference to some environment variable. I'd like to find to be able to check if they exist in the SUT environment. So I read about [capture group](https://perldoc.perl.org/perlre#Capture-groups)

Regexp to match environment variable name

```
\$\{?([a-zA-Z0-9\-_]+)\}?
```

It can be improved as it match `$HOME` and `${HOME}` but also `${HOME` .

To be used like
```
my @locations = ( ['$HOME', '.wezterm.lua'],
                  ['$HOME/.config/wezterm', 'wezterm.lua'],
                  ['$XDG_CONFIG_HOME/wezterm', 'wezterm.lua'],
                  );
for my $ref (@locations)  {
    foreach (@$ref) {
        my @captured = $_ =~ /\$\{?([a-zA-Z0-9\-_]+)\}?/g;
        if( @captured ) {
            print "-->  ";
            print join " # ", @captured;
            print "\n";
        }
    }
}

```


# TODO

## Hackweek webpage
* Create a new separate page where to start developing a hackweek presentation (reveal.js maybe)

## openQA
* Ask if it is possible to run the test on some existing openQA instance (maybe the o3 public one)
* Keep exploring [isotovideo](https://kalikiana.gitlab.io/post/2022-03-16-running-standandalone-tests-with-isotovideo/)
